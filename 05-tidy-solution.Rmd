---
title: "Tidy"
output:
  github_document: default
  pdf_document: default
---

## Setup

```{r setup}
library(tidyverse)
```



## Warm up

Packages in the tidyverse include articles that explain how to use them. 

* Go to this specific of one tidyr's article. <https://tidyr.tidyverse.org/articles/pivot.html#pew>.
* Type the two lines of code you see in the second chunk.

```{r}
relig_income %>% 
  pivot_longer(-religion, names_to = "income", values_to = "count")
```

Look and the data and code.

* Why is the input messy and the output tidy?
* Guess what each argument does.



## Data

* Read a messy dataset.

```{r}
gap_wide <- readr::read_csv('https://raw.githubusercontent.com/carpentries-incubator/open-science-with-r/gh-pages/data/gapminder_wide.csv')
```



Have a look the dataset.

```{r}
gap_wide
```

Bored?

* You know `head()` helps you see the first few rows. Which function helps you see the last few rows?
* Try `str()`. 
* Tweak `str()` with the arguments `list.len`, and `give.attr`



* From `gap_wide` select `country`, `continent` and columns starting with "gdp".

```{r}
gap_wide %>% 
  select(1, 2, starts_with("gdp"))
```



* Extend the previous pipeline.
* Pivot the dataset on the columns starting with "gdp" (the output is longer).

```{r}
gap_wide %>% 
  select(1, 2, starts_with("gdp")) %>%
  pivot_longer(cols = starts_with("gdp"))
```

Bored?

* Use arguments to get column names more informative than "name" and "value".


* Why is this longer?

```{r}
gw1 <- gap_wide %>% 
  pivot_longer(
    cols = starts_with("gdp") | starts_with("life") | starts_with("pop")
  )
gw1
```



* These alternatives are identical but shorter. How do they work?

```{r}
gw2 <- gap_wide %>% pivot_longer(cols = -continent:-country)
identical(gw1, gw2)

gw3 <- gap_wide %>% pivot_longer(cols = -1:-2)
identical(gw1, gw3)
```



`gw1` is still messy. Why?

* Tidy the dataset `gw1` using `separate()` and the vector c("metric", "year").

```{r}
tidy <- gw1 %>% separate(col = name, into = c("metric", "year"))
tidy
```



* Use `unite()` and `pivot_wider()` to mess things up again.

```{r}
messy <- tidy %>% 
  unite("name", metric, year) %>% 
  pivot_wider()

messy

gap_wide
```

## Filling missing data with `complete()`

This toy dataset has implicit missing data in year 2000. Why?

```{r}
kelp <- tibble(
  year = c(1999, 1999, 2000, 2004, 2004),
  taxon = c("Agarum", "Saccharina", "Saccharina", "Agarum", "Saccharina"),
  abundance = c(1, 4, 5, 8, 2)
)

kelp
```



* Use `complete()` to make explicit the missing data in `year` and `taxon`.

```{r}
kelp %>% complete(year, taxon)
```



Pretend in `year = 2000` you found no individual of `taxon` "Agarum".

* Use the argument `fill` to fill missing data with the value `0`.

```{r}
kelp %>% complete(year, taxon, fill = list(abundance = 0))
```



Pretend you surveyed every year from 1999 to 2004 but found nothing in 2001-3.

```{r}
success_years <- kelp %>% 
  distinct(year) %>% 
  pull(year)

success_years
```

* Use `full_seq()` to produce the full sequence of the years you surveyed.

```{r}
all_years <- success_years %>% full_seq(period = 1)
all_years
```



* Use the argument `fill` to fill missing data with the value `0`.

```{r}
kelp %>% 
  complete(year = all_years, taxon = taxon)
```


You now want to study "Agarum" only.

```{r}
agarum <- kelp %>% 
  filter(taxon == "Agarum") %>% 
  complete(year = all_years)

agarum
```

* `fill()` the missing values of `taxon`.

```{r}
agarum %>% fill(taxon)
```

* Now also `replace_na()` in `abundance` with the value `0`. Hint: One solution uses `list(abundance = 0)`

```{r}
agarum %>% 
  fill(taxon) %>% 
  replace_na(list(abundance = 0))
```

Bored? 

* See `?replace_na()` and find another solution with using `mutate()`.



***

# Take Aways

Data comes in many formats but R prefers just one: _tidy data_.

A data set is tidy if and only if:

1. Every variable is in its own column
2. Every observation is in its own row
3. Every value is in its own cell (which follows from the above)

What is a variable and an observation may depend on your immediate goal.
